
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>4.2. Counterfactual predictions for impact variables &#8212; Rethinking Measurement and Verification of Energy Savings</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://hebes-io.github.io/rethinking/chapters/04/02/Counterfactual_Impact.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="4.4. Estimation of activity levels: Part II" href="../03/Activity_Estimation_II.html" />
    <link rel="prev" title="4.1. Estimation of activity levels: Part I" href="../01/Activity_Estimation_I.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MDNY55CE4R"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-MDNY55CE4R');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/favicon.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Rethinking Measurement and Verification of Energy Savings</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../01/Background.html">
   1. The concept of measurement and verification
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../01/01/Traditional.html">
     1.1. The traditional M&amp;V approach
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../01/02/Counterfactuals.html">
     1.2. A broader way to frame the M&amp;V task
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../02/Design_Principles.html">
   2. The design principles of eensight
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../03/Preprocessing.html">
   3. The preprocess pipeline
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../03/01/Input_Validation.html">
     3.1. The input data validation stage
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../03/02/Input_Merging.html">
     3.2. The index alignment and data merging stage
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../03/03/Data_Adequacy.html">
     3.3. Evaluation of input data adequacy
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../Predict.html">
   4. The predict, evaluate and adjust pipelines
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../01/Activity_Estimation_I.html">
     4.1. Activity Estimation: Part I
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     4.2. Counterfactual predictions for impact variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/Activity_Estimation_II.html">
     4.4. Activity Estimation: Part II
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/Counterfactual_Mapping.html">
     4.5. Counterfactual predictions for mapping variables
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/hebes-io/rethinking/main?urlpath=tree/chapters/04/02/Counterfactual_Impact.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/hebes-io/rethinking"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/chapters/04/02/Counterfactual_Impact.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   4.2. Counterfactual predictions for impact variables
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-b02-dataset">
     4.2.1. The
     <em>
      b02
     </em>
     dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-predict-pipeline">
     4.2.2. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-predict-pipeline-with-autoencoding">
     4.2.3. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline with autoencoding
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-b03-dataset">
     4.2.4. The
     <em>
      b03
     </em>
     dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     4.2.5. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     4.2.6. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline with autoencoding
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parameters">
   4.3. Parameters
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Counterfactual predictions for impact variables</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   4.2. Counterfactual predictions for impact variables
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-b02-dataset">
     4.2.1. The
     <em>
      b02
     </em>
     dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-predict-pipeline">
     4.2.2. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-predict-pipeline-with-autoencoding">
     4.2.3. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline with autoencoding
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-b03-dataset">
     4.2.4. The
     <em>
      b03
     </em>
     dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     4.2.5. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     4.2.6. The
     <code class="docutils literal notranslate">
      <span class="pre">
       predict
      </span>
     </code>
     pipeline with autoencoding
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parameters">
   4.3. Parameters
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="counterfactual-predictions-for-impact-variables">
<h1><span class="section-number">4.2. </span>Counterfactual predictions for impact variables<a class="headerlink" href="#counterfactual-predictions-for-impact-variables" title="Permalink to this headline">#</a></h1>
<p>This section provides more details on the way counterfactual predictions are carried out by <code class="docutils literal notranslate"><span class="pre">eensight</span></code> for events that affect <strong>impact variables</strong>, such as an energy retrofit. To this end, it outlines the methodology behind the <code class="docutils literal notranslate"><span class="pre">predict</span></code> and <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipelines of <code class="docutils literal notranslate"><span class="pre">eensight</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%load_ext autoreload
%autoreload 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from datetime import time

import pandas as pd
import matplotlib.patches as mpatches
import matplotlib.pyplot as plt
import matplotlib.ticker as ticker

from eensight.config import ConfigLoader
from eensight.methods.prediction.baseline import UsagePredictor
from eensight.methods.prediction.activity import estimate_activity
from eensight.methods.prediction.metrics import cvrmse, nmbe
from eensight.settings import PROJECT_PATH
from eensight.utils import get_categorical_cols, load_catalog

plt.style.use(&quot;bmh&quot;)

%matplotlib inline
</pre></div>
</div>
</div>
</div>
<section id="the-b02-dataset">
<h2><span class="section-number">4.2.1. </span>The <em>b02</em> dataset<a class="headerlink" href="#the-b02-dataset" title="Permalink to this headline">#</a></h2>
<p>The <em>b02</em> dataset corresponds to the building with <code class="docutils literal notranslate"><span class="pre">id=13</span></code> of the dataset provided by the <a class="reference external" href="https://zenodo.org/record/6590976">EnergyDetective 2020</a> competition.</p>
<p>Start with the <code class="docutils literal notranslate"><span class="pre">train</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>catalog_train = load_catalog(store_uri=&quot;../../../data&quot;, site_id=&quot;b02&quot;, namespace=&quot;train&quot;)

X_train = catalog_train.load(&quot;train.preprocessed-features&quot;)
y_train = catalog_train.load(&quot;train.preprocessed-labels&quot;)
</pre></div>
</div>
</div>
</div>
<p>The following plot presents the energy consumption of the selected dataset as a function of the outdoor temperature:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

ax.scatter(X_train[&quot;temperature&quot;], y_train[&quot;consumption&quot;], s=10, alpha=0.5)
ax.set_xlabel(&quot;temperature&quot;)
ax.set_ylabel(&quot;consumption&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_8_0.png" src="../../../_images/Counterfactual_Impact_8_0.png" />
</div>
</div>
</section>
<section id="the-predict-pipeline">
<h2><span class="section-number">4.2.2. </span>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline<a class="headerlink" href="#the-predict-pipeline" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline performs the following steps:</p>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">train</span></code> namespace</strong></p>
<p>Fits a predictive model on the <code class="docutils literal notranslate"><span class="pre">train</span></code> data using the <code class="docutils literal notranslate"><span class="pre">eensight.methods.prediction.baseline.UsagePredictor</span></code> model. We don’t need to add calendar features, since the <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code> adds calendar features as needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model = UsagePredictor().fit(X_train, y_train)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace train 
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: The trained <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code> model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train.prediction</span></code>: A dataframe with the prediction generated by applying the <code class="docutils literal notranslate"><span class="pre">model</span></code> on the <code class="docutils literal notranslate"><span class="pre">train</span></code> data (in-sample prediction)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train.performance</span></code>: A JSON file with the in-sample CV(RMSE) and NMBE.</p></li>
</ul>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">test</span></code> namespace</strong></p>
<p>Load the <code class="docutils literal notranslate"><span class="pre">test</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>catalog_test = load_catalog(store_uri=&quot;../../../data&quot;, site_id=&quot;b02&quot;, namespace=&quot;test&quot;)

X_test = catalog_test.load(&quot;test.preprocessed-features&quot;)
y_test = catalog_test.load(&quot;test.preprocessed-labels&quot;)
</pre></div>
</div>
</div>
</div>
<p>Both the <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">test</span></code> period consumption data are presented in the next plot:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

y_train.plot(ax=ax, alpha=0.6)
y_test.plot(ax=ax, alpha=0.6)
ax.legend([&quot;`train` period&quot;, &quot;`test` period&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_19_0.png" src="../../../_images/Counterfactual_Impact_19_0.png" />
</div>
</div>
<p>Apply the model on the <code class="docutils literal notranslate"><span class="pre">test</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prediction = model.predict(X_test)
</pre></div>
</div>
</div>
</div>
<p>The Coefficient of Variation of the Root Mean Squared Error CV(RMSE) is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cvrmse(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.3042765589248083</span>
</pre>
</div></div>
</div>
<p>The Normalized Mean Bias Error (NMBE) is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nmbe(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.007393580383622497</span>
</pre>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code> model allows us to add time lags for selected features. If we want to add 1-hour, 2-hour and 24-hour time lags for <code class="docutils literal notranslate"><span class="pre">temperature</span></code>, we can write:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>lags = {&quot;temperature&quot;: [1, 2, 24]}

model = UsagePredictor(lags=lags).fit(X_train, y_train)
</pre></div>
</div>
</div>
</div>
<p>Adding time lags may improve the accuracy of the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prediction = model.predict(X_test)
cvrmse(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.29944357827501156</span>
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nmbe(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.005027632126261972</span>
</pre>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace <span class="nb">test</span> 
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test.prediction</span></code>: A dataframe with the prediction generated by applying the <code class="docutils literal notranslate"><span class="pre">model</span></code> on the <code class="docutils literal notranslate"><span class="pre">test</span></code> data (out-of-sample prediction)</p></li>
</ul>
<p>To actually get the metrics for the predictive performance of the model, we have to call the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipeline:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run evaluate --site-id b02 --store-uri ../../../data --namespace <span class="nb">test</span> 
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test.performance</span></code>: A JSON file with the out-of-sample CV(RMSE) and NMBE.</p></li>
</ul>
<p>Note that:</p>
<ol class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline must be called first in the <code class="docutils literal notranslate"><span class="pre">train</span></code> namespace and, then, in the <code class="docutils literal notranslate"><span class="pre">test</span></code> one, so that the <code class="docutils literal notranslate"><span class="pre">model</span></code> is available.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline must be called before the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>, so that the <code class="docutils literal notranslate"><span class="pre">test.prediction</span></code> is available to the latter.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipeline supports only the <code class="docutils literal notranslate"><span class="pre">test</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> namespaces.</p></li>
</ol>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> namespace</strong></p>
<p>We can use the fitted model to carry out a counterfactual prediction for the <code class="docutils literal notranslate"><span class="pre">apply</span></code> period:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>catalog_apply = load_catalog(store_uri=&quot;../../../data&quot;, site_id=&quot;b02&quot;, namespace=&quot;apply&quot;)

X_apply = catalog_apply.load(&quot;apply.preprocessed-features&quot;)
y_apply = catalog_apply.load(&quot;apply.preprocessed-labels&quot;)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">train</span></code>, <code class="docutils literal notranslate"><span class="pre">test</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> period consumption data are presented in the next plot:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

y_train.plot(ax=ax, alpha=0.6)
y_test.plot(ax=ax, alpha=0.6)
y_apply.plot(ax=ax, alpha=0.6)

ax.legend([&quot;`train` period&quot;, &quot;`test` period&quot;, &quot;`apply` period&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_36_0.png" src="../../../_images/Counterfactual_Impact_36_0.png" />
</div>
</div>
<p>Evaluate the model on the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prediction = model.predict(X_apply)
</pre></div>
</div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> data are separated by an event (<code class="docutils literal notranslate"><span class="pre">train</span></code> is pre-event data and <code class="docutils literal notranslate"><span class="pre">apply</span></code> is post-event), the difference between the predicted and the actual energy consumption is an estimation of the event’s impact.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>impact = prediction - y_apply[&quot;consumption&quot;]
</pre></div>
</div>
</div>
</div>
<p>Typically, the impact (expressed in this case as energy savings) is visualized as a cumulative variable:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

impact.cumsum().plot(ax=ax)

ax.set_xlabel(&#39;Hours&#39;)
ax.set_ylabel(&#39;Energy savings&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_42_0.png" src="../../../_images/Counterfactual_Impact_42_0.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace apply 
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply.prediction</span></code>: A dataframe with the prediction generated by applying the <code class="docutils literal notranslate"><span class="pre">model</span></code> on the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data (counterfactual prediction)</p></li>
</ul>
<p>To actually get the impact estimation, we have to call the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipeline:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run evaluate --site-id b02 --store-uri ../../../data --namespace apply 
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply.impact</span></code>: A dataframe with the difference between the predicted and the actual energy consumption.</p></li>
</ul>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline must be called before the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>, so that the <code class="docutils literal notranslate"><span class="pre">apply.prediction</span></code> is available to the latter.</p>
<p>In practice, the predicitive model can be used for generating counterfactual energy consumption predictions until we observe enough data in the reporting period. When enough data is available, we can run the <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline with the flag <code class="docutils literal notranslate"><span class="pre">--autoencode</span></code>.</p>
<p>In this case:</p>
</section>
<section id="the-predict-pipeline-with-autoencoding">
<h2><span class="section-number">4.2.3. </span>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline with autoencoding<a class="headerlink" href="#the-predict-pipeline-with-autoencoding" title="Permalink to this headline">#</a></h2>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">train</span></code> namespace</strong></p>
<p>First, estimate activity levels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for feature in X_train.columns:
    print(feature)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>temperature
dew point temperature
relative humidity
atmospheric pressure
wind speed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>non_occ_features = [
    &quot;temperature&quot;,
    &quot;dew point temperature&quot;,
    &quot;relative humidity&quot;,
    &quot;atmospheric pressure&quot;,
    &quot;wind speed&quot;
]

act_train = estimate_activity(
    X_train, 
    y_train, 
    non_occ_features=non_occ_features, 
    exog=&quot;temperature&quot;,
    n_trials=200,
    verbose=False,
)
</pre></div>
</div>
</div>
</div>
<p>Then, fit a predictive model for the <code class="docutils literal notranslate"><span class="pre">train</span></code> data using the activity estimation as a feature. In this case, we set the <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code>’s parameter <code class="docutils literal notranslate"><span class="pre">skip_calendar</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>, so that calendar features are not generated automatically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train_act = pd.concat(
    [
        X_train,
        act_train.to_frame(&quot;activity&quot;)
        
    ], 
    axis=1
)

model_autoenc = UsagePredictor(lags=lags, skip_calendar=True).fit(X_train_act, y_train)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace train --autoencode
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">train.activity</span></code>: Dataframe with the estimated activity levels for the <code class="docutils literal notranslate"><span class="pre">train</span></code> data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model-autoenc</span></code>: The trained <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code> model using activity levels as a feature.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train.prediction-autoenc</span></code>: A dataframe with the prediction generated by applying <code class="docutils literal notranslate"><span class="pre">model-autoenc</span></code> on the <code class="docutils literal notranslate"><span class="pre">train</span></code> data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train.performance-autoenc</span></code>: A JSON file with the CV(RMSE) and NMBE.</p></li>
</ul>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">test</span></code> namespace</strong></p>
<p>Estimate activity levels:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>act_test = estimate_activity(
    X_test, 
    y_test, 
    non_occ_features=non_occ_features, 
    exog=&quot;temperature&quot;,
    n_trials=200,
    verbose=False,
)
</pre></div>
</div>
</div>
</div>
<p>Use the model that was fitted on the <code class="docutils literal notranslate"><span class="pre">train</span></code> data to predict energy consumption:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_test_act = pd.concat(
    [
        X_test,
        act_test.to_frame(&quot;activity&quot;)
    ], 
    axis=1
)

prediction = model_autoenc.predict(X_test_act)
</pre></div>
</div>
</div>
</div>
<p>Autoencoding improves predictive accuracy on <code class="docutils literal notranslate"><span class="pre">test</span></code> data, but not in a drastic way that would indicate overfitting due to data leakage:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cvrmse(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.2805189614516902</span>
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nmbe(y_test, prediction)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.03583116402388926</span>
</pre>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace <span class="nb">test</span> --autoencode
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test.activity</span></code>: Dataframe with the estimated activity levels for the <code class="docutils literal notranslate"><span class="pre">test</span></code> data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test.prediction-autoenc</span></code>: A dataframe with the prediction generated by applying <code class="docutils literal notranslate"><span class="pre">model-autoenc</span></code> on the <code class="docutils literal notranslate"><span class="pre">test</span></code> data</p></li>
</ul>
<p>To actually get the metrics for the predictive performance of the model, we have to call the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipeline:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run evaluate --site-id b02 --store-uri ../../../data --namespace <span class="nb">test</span> --autoencode
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test.performance-autoenc</span></code>: A JSON file with the CV(RMSE) and NMBE values.</p></li>
</ul>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline must be called before the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>, so that the <code class="docutils literal notranslate"><span class="pre">test.prediction-autoenc</span></code> is available to the latter.</p>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> namespace</strong></p>
<p>Estimate activity levels:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>act_apply = estimate_activity(
    X_apply, 
    y_apply, 
    non_occ_features=non_occ_features, 
    exog=&quot;temperature&quot;,
    n_trials=200,
    verbose=False,
)
</pre></div>
</div>
</div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline runs on the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data, the consumption model generates a counterfactual prediction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_counter = pd.concat(
    [
        X_apply,
        act_apply.to_frame(&quot;activity&quot;)
    ], 
    axis=1
)

prediction = model_autoenc.predict(X_counter)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>impact_autoenc = prediction - y_apply[&quot;consumption&quot;]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline can be called from the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run predict --site-id b02 --store-uri ../../../data --namespace apply --autoencode
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply.activity</span></code>: Dataframe with the estimated activity levels for the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apply.prediction-autoenc</span></code>: A dataframe with the prediction generated by applying <code class="docutils literal notranslate"><span class="pre">model-autoenc</span></code> on the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data.</p></li>
</ul>
<p>To actually get the impact estimation, we have to call the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> pipeline:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eensight run evaluate --site-id b02 --store-uri ../../../data --namespace apply --autoencode
</pre></div>
</div>
<p>Running the pipeline will create the following artifacts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply.impact-autoenc</span></code>: A dataframe with the difference between the predicted and the actual energy consumption.</p></li>
</ul>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline must be called before the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>, so that the <code class="docutils literal notranslate"><span class="pre">apply.prediction-autoenc</span></code> is available to the latter.</p>
<p>We can compare the estimated impact from the two approaches:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

impact.cumsum().plot(ax=ax)
impact_autoenc.cumsum().plot(ax=ax)

ax.set_xlabel(&#39;Hours&#39;)
ax.set_ylabel(&#39;Energy savings&#39;)
ax.legend([&quot;Impact estimation&quot;, &quot;Updated impact estimation&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_70_0.png" src="../../../_images/Counterfactual_Impact_70_0.png" />
</div>
</div>
<p><em>What drives the difference between the two impact estimations and which one should we trust more?</em></p>
<p>Let’s isolate all <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> observations where temperature is lower than 20<span class="math notranslate nohighlight">\(^{\circ}C\)</span> and activity equals one (1):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>low_temp_periods_train = X_train[X_train[&quot;temperature&quot;] &lt;= 20].index

y_train_selected = y_train[
    y_train.index.isin(low_temp_periods_train) 
    &amp; y_train.index.isin(act_train[act_train == 1].index)
]

low_temp_periods_apply = X_apply[X_apply[&quot;temperature&quot;] &lt;= 20].index

y_apply_selected = y_apply[
    y_apply.index.isin(low_temp_periods_apply) 
    &amp; y_apply.index.isin(act_apply[act_apply == 1].index)
]
</pre></div>
</div>
</div>
</div>
<p>We can plot the two subsets side by side:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, (ax1, ax2) = plt.subplots(1, 2, sharey=True, figsize=(12, 4))
fig.subplots_adjust(wspace=0.04)

ax1.scatter(
    X_train.loc[~X_train.index.isin(y_train_selected.index), &quot;temperature&quot;], 
    y_train.loc[~y_train.index.isin(y_train_selected.index), &quot;consumption&quot;], 
    s=10, 
    alpha=0.8
)

ax1.scatter(
    X_train.loc[y_train_selected.index, &quot;temperature&quot;], 
    y_train_selected[&quot;consumption&quot;], 
    s=10, 
    alpha=0.4,
    color=&quot;#fe9929&quot;
)

ax1.set_xlabel(&quot;temperature&quot;)
ax1.set_ylabel(&quot;consumption&quot;)
ax1.set_title(&quot;`train` data&quot;)

ax1.legend(
    handles=[
        mpatches.Patch(color=&quot;#fe9929&quot;, label=&quot;Selected subset&quot;), 
    ]
)

ax2.scatter(
    X_apply.loc[~X_apply.index.isin(y_apply_selected.index), &quot;temperature&quot;], 
    y_apply.loc[~y_apply.index.isin(y_apply_selected.index), &quot;consumption&quot;],
    s=10, 
    alpha=0.8
)

ax2.scatter(
    X_apply.loc[y_apply_selected.index, &quot;temperature&quot;], 
    y_apply_selected[&quot;consumption&quot;], 
    s=10, 
    alpha=0.4,
    color=&quot;#fe9929&quot;
)

ax2.set_xlabel(&quot;temperature&quot;)
ax2.set_title(&quot;`apply` data&quot;)

ax2.legend(
    handles=[
        mpatches.Patch(color=&quot;#fe9929&quot;, label=&quot;Selected subset&quot;), 
    ]
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_74_0.png" src="../../../_images/Counterfactual_Impact_74_0.png" />
</div>
</div>
<p>First, we will plot the distribution of the <strong>actual</strong> energy consumption for the selected <code class="docutils literal notranslate"><span class="pre">train</span></code> and the <code class="docutils literal notranslate"><span class="pre">apply</span></code> observations:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

y_train_selected.plot.kde(ax=ax, color=&quot;#034e7b&quot;)
y_apply_selected.plot.kde(ax=ax, color=&quot;#cc4c02&quot;)

selected_train_average = y_train_selected[&quot;consumption&quot;].mean()
selected_apply_average = y_apply_selected[&quot;consumption&quot;].mean()

ax.axvline(x=selected_train_average, color=&quot;#034e7b&quot;, ls=&quot;:&quot;)
ax.axvline(x=selected_apply_average, color=&quot;#cc4c02&quot;, ls=&quot;:&quot;)

ax.annotate(
    f&quot;Average change: {round(selected_apply_average - selected_train_average, 2)}&quot;, 
    xy=(490, 0.001), 
    xytext=(150, 0.0032), 
    arrowprops={&quot;arrowstyle&quot;:&quot;-&gt;&quot;, &quot;color&quot;:&quot;black&quot;}
)

ax.legend([&quot;`train` data&quot;, &quot;`apply` data&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_76_0.png" src="../../../_images/Counterfactual_Impact_76_0.png" />
</div>
</div>
<p>This is pretty much how a counterfactual prediction should work: find similar conditions between the pre- and post-event data (here, similar temperature and activity levels), and compare the difference in the energy consumption.</p>
<p>Next, we will estimate the energy consumption using the predictive model and compare the predicted with the actual consumption:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_apply_selected = X_apply.loc[y_apply_selected.index]

prediction = model.predict(X_apply_selected)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

prediction.plot.kde(ax=ax, color=&quot;#034e7b&quot;)
y_apply_selected.plot.kde(ax=ax, color=&quot;#cc4c02&quot;)

prediction_average = prediction.mean()
selected_apply_average = y_apply_selected[&quot;consumption&quot;].mean()

ax.axvline(x=prediction_average, color=&quot;#034e7b&quot;, ls=&quot;:&quot;)
ax.axvline(x=selected_apply_average, color=&quot;#cc4c02&quot;, ls=&quot;:&quot;)

ax.annotate(
    f&quot;Average change: {round(selected_apply_average - prediction_average, 2)}&quot;, 
    xy=(450, 0.001), 
    xytext=(150, 0.0035), 
    arrowprops={&quot;arrowstyle&quot;:&quot;-&gt;&quot;, &quot;color&quot;:&quot;black&quot;}
)

ax.legend([&quot;Counterfractual prediction&quot;, &quot;`apply` data&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_80_0.png" src="../../../_images/Counterfactual_Impact_80_0.png" />
</div>
</div>
<p>Finally, we will estimate the energy consumption using the autoencoding model and compare the predicted with the actual consumption:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_counter = pd.concat(
    [
        X_apply_selected,
        act_apply.loc[X_apply_selected.index].to_frame(&quot;activity&quot;)
    ], 
    axis=1
)

prediction = model_autoenc.predict(X_counter)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

prediction.plot.kde(ax=ax, color=&quot;#034e7b&quot;)
y_apply_selected.plot.kde(ax=ax, color=&quot;#cc4c02&quot;)

prediction_average = prediction.mean()
selected_apply_average = y_apply_selected[&quot;consumption&quot;].mean()

ax.axvline(x=prediction_average, color=&quot;#034e7b&quot;, ls=&quot;:&quot;)
ax.axvline(x=selected_apply_average, color=&quot;#cc4c02&quot;, ls=&quot;:&quot;)

ax.annotate(
    f&quot;Average change: {round(selected_apply_average - prediction_average, 2)}&quot;, 
    xy=(490, 0.001), 
    xytext=(210, 0.0045), 
    arrowprops={&quot;arrowstyle&quot;:&quot;-&gt;&quot;, &quot;color&quot;:&quot;black&quot;}
)

ax.legend([&quot;Counterfractual prediction&quot;, &quot;`apply` data&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_83_0.png" src="../../../_images/Counterfactual_Impact_83_0.png" />
</div>
</div>
<p>As we can see from the plots, the autoencoding approach provides a generally better representation of the actual impact.</p>
</section>
<section id="the-b03-dataset">
<h2><span class="section-number">4.2.4. </span>The <em>b03</em> dataset<a class="headerlink" href="#the-b03-dataset" title="Permalink to this headline">#</a></h2>
<p>The <em>b03</em> data corresponds to the building with <code class="docutils literal notranslate"><span class="pre">id=50</span></code> from the dataset of the <a class="reference external" href="https://www.drivendata.org/competitions/51/electricity-prediction-machine-learning/page/101/">Power Laws: Forecasting Energy Consumption</a> competition.</p>
<p>Start with the <code class="docutils literal notranslate"><span class="pre">train</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>catalog_train = load_catalog(store_uri=&quot;../../../data&quot;, site_id=&quot;b03&quot;, namespace=&quot;train&quot;)

X_train = catalog_train.load(&quot;train.preprocessed-features&quot;)
y_train = catalog_train.load(&quot;train.preprocessed-labels&quot;)
</pre></div>
</div>
</div>
</div>
<p>The following plot presents the energy consumption of the selected dataset as a function of the outdoor temperature:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

ax.scatter(X_train[&quot;temperature&quot;], y_train[&quot;consumption&quot;], s=10, alpha=0.2)
ax.set_xlabel(&quot;temperature&quot;)
ax.set_ylabel(&quot;consumption&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_89_0.png" src="../../../_images/Counterfactual_Impact_89_0.png" />
</div>
</div>
</section>
<section id="id1">
<h2><span class="section-number">4.2.5. </span>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">train</span></code> namespace</strong></p>
<p>Fit a predictive model on the <code class="docutils literal notranslate"><span class="pre">train</span></code> data using the <code class="docutils literal notranslate"><span class="pre">UsagePredictor</span></code> model. Note that there is one <strong>categorical feature</strong> in the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>get_categorical_cols(X_train, int_is_categorical=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'holiday'</span><span style="font-weight: bold">]</span>
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model = UsagePredictor(cat_features=&quot;holiday&quot;).fit(X_train, y_train)
</pre></div>
</div>
</div>
</div>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> namespace</strong></p>
<p>Load the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>catalog_apply = load_catalog(store_uri=&quot;../../../data&quot;, site_id=&quot;b03&quot;, namespace=&quot;apply&quot;)

X_apply = catalog_apply.load(&quot;apply.preprocessed-features&quot;)
y_apply = catalog_apply.load(&quot;apply.preprocessed-labels&quot;)
</pre></div>
</div>
</div>
</div>
<p>Both the <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> period consumption data are presented in the next plot:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

y_train.plot(ax=ax, alpha=0.6)
y_apply.plot(ax=ax, alpha=0.6)
ax.legend([&quot;`train` period&quot;, &quot;`apply` period&quot;], frameon=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_99_0.png" src="../../../_images/Counterfactual_Impact_99_0.png" />
</div>
</div>
<p>Evaluate the model on the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prediction = model.predict(X_apply)
</pre></div>
</div>
</div>
</div>
<p>For this dataset, there is a time shift in the daily profiles between the <code class="docutils literal notranslate"><span class="pre">train</span></code> and the <code class="docutils literal notranslate"><span class="pre">apply</span></code> data. This time shift can be spotted when directly comparing the <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> daily profiles:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_train_daily = y_train.copy()
y_train_daily[&quot;date&quot;] = y_train_daily.index.date
y_train_daily[&quot;time&quot;] = y_train_daily.index.time

y_apply_daily = y_apply.copy()
y_apply_daily[&quot;date&quot;] = y_apply_daily.index.date
y_apply_daily[&quot;time&quot;] = y_apply_daily.index.time
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

y_train_daily.pivot(index=&quot;time&quot;, columns=&quot;date&quot;, values=&quot;consumption&quot;) \
             .plot(ax=ax, alpha=0.02, legend=None, color=&#39;#0570b0&#39;)
y_apply_daily.pivot(index=&quot;time&quot;, columns=&quot;date&quot;, values=&quot;consumption&quot;) \
             .plot(ax=ax, alpha=0.02, legend=None, color=&#39;#7a0177&#39;)

ax.axvspan(time(6, 0), time(8, 0), alpha=0.2, color=&quot;red&quot;)
ax.axvspan(time(14, 0), time(16, 0), alpha=0.2, color=&quot;red&quot;)

ax.xaxis.set_major_locator(ticker.MultipleLocator(3600*2))
ax.set_xlabel(&#39;Hours&#39;)

ax.legend(
    handles=[
        mpatches.Patch(color=&quot;#0570b0&quot;, label=&quot;`train` data&quot;), 
        mpatches.Patch(color=&quot;#7a0177&quot;, label=&quot;`apply` data&quot;)
    ]
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_104_0.png" src="../../../_images/Counterfactual_Impact_104_0.png" />
</div>
</div>
<p>The plot suggests a significant misalignment in the occupancy patterns between the <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> data during the hour intervals of 06:00-08:00 and 14:00-16:00. Let’s see if we are able to capture it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>change = y_apply[&quot;consumption&quot;] - prediction # as consumption increase

change_daily = change.to_frame(&quot;change&quot;)
change_daily[&quot;date&quot;] = change_daily.index.date
change_daily[&quot;time&quot;] = change_daily.index.time
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

change_daily.pivot(index=&#39;time&#39;, columns=&#39;date&#39;, values=&#39;change&#39;) \
            .mean(axis=1)                                      \
            .plot(ax=ax, alpha=0.8, legend=None, color=&#39;#0570b0&#39;)

ax.axvspan(time(6, 0), time(8, 0), alpha=0.2, color=&quot;red&quot;)
ax.axvspan(time(14, 0), time(16, 0), alpha=0.2, color=&quot;red&quot;)

ax.xaxis.set_major_locator(ticker.MultipleLocator(3600*2))
ax.set_xlabel(&#39;Hours&#39;)
ax.set_ylabel(&#39;Median error between actual \nand predicted consumption&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_107_0.png" src="../../../_images/Counterfactual_Impact_107_0.png" />
</div>
</div>
</section>
<section id="id2">
<h2><span class="section-number">4.2.6. </span>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> pipeline with autoencoding<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h2>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">train</span></code> namespace</strong></p>
<p>Estimate activity levels for the <code class="docutils literal notranslate"><span class="pre">train</span></code> data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for feature in X_train.columns:
    print(feature)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>holiday
temperature
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>act_train = estimate_activity(
    X_train, 
    y_train, 
    non_occ_features=&quot;temperature&quot;, 
    exog=&quot;temperature&quot;,
    n_trials=200,
    verbose=False,
)
</pre></div>
</div>
</div>
</div>
<p>Then, fit a predictive model for the <code class="docutils literal notranslate"><span class="pre">train</span></code> data using the activity estimation as a feature, while removing occupancy related features:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train_act = pd.concat(
    [
        X_train.drop(&quot;holiday&quot;, axis=1),
        act_train.to_frame(&quot;activity&quot;)
        
    ], 
    axis=1
)

model = UsagePredictor(skip_calendar=True).fit(X_train_act, y_train)
</pre></div>
</div>
</div>
</div>
<p><strong>When run in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> namespace</strong></p>
<p>Estimate activity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>act_apply = estimate_activity(
    X_apply, 
    y_apply, 
    non_occ_features=&quot;temperature&quot;, 
    exog=&quot;temperature&quot;,
    n_trials=200,
    verbose=False,
)
</pre></div>
</div>
</div>
</div>
<p>Apply the predictive model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_apply_act = pd.concat(
    [
        X_apply.drop(&quot;holiday&quot;, axis=1),
        act_apply.to_frame(&quot;activity&quot;)
    ], 
    axis=1
)

prediction = model.predict(X_apply_act)
</pre></div>
</div>
</div>
</div>
<p>Calculate the impact from the change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>change_auto = y_apply[&quot;consumption&quot;] - prediction # as consumption increase

change_daily_auto = change_auto.to_frame(&quot;change&quot;)
change_daily_auto[&quot;date&quot;] = change_daily_auto.index.date
change_daily_auto[&quot;time&quot;] = change_daily_auto.index.time
</pre></div>
</div>
</div>
</div>
<p>The next plot shows the two impact estimations together:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

change_daily.pivot(index=&#39;time&#39;, columns=&#39;date&#39;, values=&#39;change&#39;) \
               .mean(axis=1)                                      \
               .plot(ax=ax, alpha=0.8, legend=None, color=&#39;#0570b0&#39;)

change_daily_auto.pivot(index=&#39;time&#39;, columns=&#39;date&#39;, values=&#39;change&#39;) \
               .mean(axis=1)                                      \
               .plot(ax=ax, alpha=0.8, legend=None, color=&#39;#fd8d3c&#39;)

ax.legend(
    [
        &quot;Change estimation through prediction&quot;, 
        &quot;Change estimation through autoencoding&quot;
    ], 
    frameon=True
)

ax.axvspan(time(6, 0), time(8, 0), alpha=0.2, color=&quot;red&quot;)
ax.axvspan(time(14, 0), time(16, 0), alpha=0.2, color=&quot;red&quot;)

ax.xaxis.set_major_locator(ticker.MultipleLocator(3600*2))
ax.set_xlabel(&#39;Hours&#39;)
ax.set_ylabel(&#39;Average change in consumption&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_123_0.png" src="../../../_images/Counterfactual_Impact_123_0.png" />
</div>
</div>
<p>To understand the difference between the two (2) impact estimations, we can see how the estimated activity levels in <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">apply</span></code> periods differ from each other:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>act_train_daily = act_train.to_frame(&quot;activity&quot;)
act_train_daily[&quot;date&quot;] = act_train_daily.index.date
act_train_daily[&quot;time&quot;] = act_train_daily.index.time

act_apply_daily = act_apply.to_frame(&quot;activity&quot;)
act_apply_daily[&quot;date&quot;] = act_apply_daily.index.date
act_apply_daily[&quot;time&quot;] = act_apply_daily.index.time
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12, 4))
layout = (1, 1)
ax = plt.subplot2grid(layout, (0, 0))

act_train_daily.pivot(index=&#39;time&#39;, columns=&#39;date&#39;, values=&#39;activity&#39;) \
               .mean(axis=1)                                      \
               .plot(ax=ax, alpha=0.8, legend=None, color=&#39;#0570b0&#39;)

act_apply_daily.pivot(index=&#39;time&#39;, columns=&#39;date&#39;, values=&#39;activity&#39;) \
               .mean(axis=1)                                      \
               .plot(ax=ax, alpha=0.8, legend=None, color=&#39;#fd8d3c&#39;)

ax.legend(
    [
        &quot;Activity estimation for `train` data&quot;, 
        &quot;Activity estimation for `apply` data&quot;
    ], 
    frameon=True
)

ax.axvspan(time(6, 0), time(8, 0), alpha=0.2, color=&quot;red&quot;)
ax.axvspan(time(14, 0), time(16, 0), alpha=0.2, color=&quot;red&quot;)

ax.xaxis.set_major_locator(ticker.MultipleLocator(3600*2))
ax.set_xlabel(&#39;Hours&#39;)
ax.set_ylabel(&#39;Average change in activity&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_126_0.png" src="../../../_images/Counterfactual_Impact_126_0.png" />
</div>
</div>
<p>The autoencoding approach gives much less weight to changes in energy consumption that can be accounted for by changes in activity levels. For instance:</p>
<ul class="simple">
<li><p>There is a change in the activity levels during the hour interval of 07:00-08:00, so the impact that is estimated by the autoencoding approach during this interval will be lower than the impact estimated by the prediction-based approach.</p></li>
<li><p>The autoencoding approach regards the change of energy consumption during the hour interval of 14:00-16:00 mainly as activity driven (a shift in activity levels) and, as a result, the counterfactual prediction for this interval is practically flat.</p></li>
</ul>
<p>Finally, the following plot shows the estimated activity levels along with the actual energy consumption for the <code class="docutils literal notranslate"><span class="pre">apply</span></code> period and for the first two (2) weeks of January:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>month = 1 # January
n_obs = 14*24*4

fig = plt.figure(figsize=(12, 4.5))
layout = (1, 1)
ax1 = plt.subplot2grid(layout, (0, 0))
ax2 = ax1.twinx()

y_apply[&quot;consumption&quot;].loc[y_apply.index.month==month][:n_obs].plot(
    ax=ax1, color=&quot;#08519c&quot;, alpha=0.8
)
act_apply.loc[act_apply.index.month==month][:n_obs].plot(ax=ax2, color=&quot;red&quot;, alpha=0.6)


ax1.set_ylabel(&quot;Energy consumption&quot;, color=&quot;#08519c&quot;)
ax2.set_ylabel(&quot;Activity levels&quot;, color=&quot;red&quot;)
ax1.set_xlabel(&quot;&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/Counterfactual_Impact_129_0.png" src="../../../_images/Counterfactual_Impact_129_0.png" />
</div>
</div>
</section>
</section>
<section id="parameters">
<h1><span class="section-number">4.3. </span>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">#</a></h1>
<p>The relevant parameters - as they can be found in the <code class="docutils literal notranslate"><span class="pre">eensight/conf/base/parameters/predict.yml</span></code> file - are:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>params = ConfigLoader(PROJECT_PATH / &quot;conf&quot;).get(&quot;parameters*&quot;, &quot;parameters*/**&quot;, &quot;**/parameters*&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>params = {
    &quot;fit&quot;: params[&quot;fit&quot;],
    &quot;activity&quot;: params[&quot;activity&quot;]
}

for name in (&quot;assume_hurdle&quot;, &quot;n_trials_adjust&quot;, &quot;upper_bound&quot;):
    params[&quot;activity&quot;].pop(name)
    
params
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
<span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'fit'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'lags'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'temperature'</span>: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span><span style="font-weight: bold">]}</span>, <span style="color: #008000; text-decoration-color: #008000">'cat_features'</span>: <span style="color: #008000; text-decoration-color: #008000">'holiday'</span>, <span style="color: #008000; text-decoration-color: #008000">'validation_size'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.2</span><span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'activity'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'non_occ_features'</span>: <span style="color: #008000; text-decoration-color: #008000">'temperature'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'cat_features'</span>: <span style="color: #008000; text-decoration-color: #008000">'holiday'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'exog'</span>: <span style="color: #008000; text-decoration-color: #008000">'temperature'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'n_trials'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">200</span>,
        <span style="color: #008000; text-decoration-color: #008000">'verbose'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>
</div></div>
</div>
<hr class="docutils" />
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters\04\02"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../01/Activity_Estimation_I.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">4.1. </span>Estimation of activity levels: Part I</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../03/Activity_Estimation_II.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">4.4. </span>Estimation of activity levels: Part II</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    <div class="extra_footer">
      <div>
  <div style="width:49%;Float:left;display:inline;">
    <div>By Sotiris Papadelis</div>
    <div>&#169; Copyright 2023</div>
  </div>
  <div style="width:49%;Float:right;display:inline;">
    <img align="left" width="500" src="https://github.com/hebes-io/eensight/raw/master/EC_support.png">
  </div>
</div>

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>